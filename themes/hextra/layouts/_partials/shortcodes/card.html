{{- $link := .link -}}
{{- $title := .title -}}
{{- $icon := .icon -}}
{{- $subtitle := .subtitle -}}
{{- $image := .image -}}
{{- $alt := .alt | default $title -}}
{{- $width := .width -}}
{{- $height := .height -}}
{{- $imageStyle := .imageStyle -}}
{{- $tag := .tag -}}
{{- $tagColor := .tagColor | default .tagType | default "" -}}{{- /* Compatibility with previous parameter. */ -}}
{{- $tagBorder := not (eq .tagBorder false) | default true }}
{{- $tagIcon := .tagIcon -}}
{{- $copyText := .copyText | default "" -}}

{{ $linkClass := "hx:hover:border-gray-300 hx:bg-transparent hx:shadow-xs hx:dark:border-neutral-800 hx:hover:bg-slate-50 hx:hover:shadow-md hx:dark:hover:border-neutral-700 hx:dark:hover:bg-neutral-900" }}
{{- with $image -}}
  {{ $linkClass = "hx:hover:border-gray-300 hx:bg-gray-100 hx:shadow-sm hx:dark:border-neutral-700 hx:dark:bg-neutral-800 hx:dark:text-gray-50 hx:hover:shadow-lg hx:dark:hover:border-neutral-500 hx:dark:hover:bg-neutral-700" }}
{{- end -}}

{{- $external := false -}}
{{- $href := "" -}}
{{- if $link -}}
  {{- $external = strings.HasPrefix $link "http" -}}
  {{- $href = cond (strings.HasPrefix $link "/") ($link | relURL) $link -}}
{{- end -}}

{{/* Shared inner content: image, title, subtitle, tag */}}
{{- define "card-inner" -}}
  {{- $image := .image -}}
  {{- $alt := .alt -}}
  {{- $width := .width -}}
  {{- $height := .height -}}
  {{- $imageStyle := .imageStyle -}}
  {{- $icon := .icon -}}
  {{- $title := .title -}}
  {{- $subtitle := .subtitle -}}
  {{- $tag := .tag -}}
  {{- $tagColor := .tagColor -}}
  {{- $tagBorder := .tagBorder -}}
  {{- $tagIcon := .tagIcon -}}

  {{- with $image -}}
    <img
      alt="{{ $alt }}"
      class="hextra-card-image"
      loading="lazy"
      decoding="async"
      src="{{ $image | safeURL }}"
      {{ with $width }}width="{{ . }}"{{ end }}
      {{ with $height }}height="{{ . }}"{{ end }}
      {{ with $imageStyle }}style="{{ . | safeCSS }}"{{ end }}
    />
  {{- end -}}

  {{- $padding := "hx:p-4" -}}
  {{- with $subtitle -}}
    {{- $padding = "hx:pt-4 hx:px-4" -}}
  {{- end -}}

  <div class="hx:mt-auto">
    <span class="hextra-card-icon hx:flex hx:font-semibold hx:items-start hx:gap-2 {{ $padding }} hx:text-gray-700 hx:hover:text-gray-900 hx:dark:text-neutral-200 hx:dark:hover:text-neutral-50">
      {{- with $icon }}{{ partial "utils/icon.html" (dict "name" $icon) -}}{{- end -}}
      {{- $title -}}
    </span>
    {{- with $subtitle -}}
      <div class="hextra-card-subtitle hx:line-clamp-3 hx:text-sm hx:font-normal hx:text-gray-500 hx:dark:text-gray-400 hx:px-4 hx:mb-4 hx:mt-2">{{- $subtitle | markdownify -}}</div>
    {{- end -}}
  </div>

  {{- if $tag }}
    {{- partial "shortcodes/badge.html" (dict
      "content" $tag
      "color" $tagColor
      "class" "hextra-card-tag"
      "border" $tagBorder
      "icon" $tagIcon
      )
    -}}
  {{- end -}}
{{- end -}}

{{/* ---------- COPY CARD: renders a <div> with onclick ---------- */}}
{{- if $copyText -}}
<div
  class="hextra-card hx:relative hx:group hx:flex hx:flex-col hx:justify-start hx:overflow-hidden hx:rounded-lg hx:border hx:border-gray-200 hx:text-current hx:no-underline hx:dark:shadow-none hx:hover:shadow-gray-100 hx:dark:hover:shadow-none hx:shadow-gray-100 hx:active:shadow-sm hx:active:shadow-gray-200 hx:transition-all hx:duration-200 hx:cursor-pointer {{ $linkClass }}"
  data-copy-text="{{ $copyText }}"
  onclick="hextraCopyCard(this)"
>
  {{- template "card-inner" (dict
    "image"      $image
    "alt"        $alt
    "width"      $width
    "height"     $height
    "imageStyle" $imageStyle
    "icon"       $icon
    "title"      $title
    "subtitle"   $subtitle
    "tag"        $tag
    "tagColor"   $tagColor
    "tagBorder"  $tagBorder
    "tagIcon"    $tagIcon
  ) -}}

  <!-- Feedback overlay shown briefly after copying -->
  <span class="hextra-card-copy-feedback" style="display:none; position:absolute; inset:0; align-items:center; justify-content:center; background:rgba(30,30,30,0.82); color:#fff; font-size:0.85rem; font-weight:600; border-radius:0.5rem; pointer-events:none; z-index:10; letter-spacing:0.02em;">
    âœ“ Copied!
  </span>
</div>

<script>
(function () {
  if (window.__hextraCopyCard) return; // only define once
  window.__hextraCopyCard = true;

  window.hextraCopyCard = function (el) {
    var text = el.dataset.copyText;
    navigator.clipboard.writeText(text).then(function () {
      var feedback = el.querySelector('.hextra-card-copy-feedback');
      feedback.style.display = 'flex';
      setTimeout(function () {
        feedback.style.display = 'none';
      }, 1500);
    });
  };
})();
</script>

{{/* ---------- LINK CARD: original <a> tag, completely untouched ---------- */}}
{{- else -}}
<a
  class="hextra-card hx:group hx:flex hx:flex-col hx:justify-start hx:overflow-hidden hx:rounded-lg hx:border hx:border-gray-200 hx:text-current hx:no-underline hx:dark:shadow-none hx:hover:shadow-gray-100 hx:dark:hover:shadow-none hx:shadow-gray-100 hx:active:shadow-sm hx:active:shadow-gray-200 hx:transition-all hx:duration-200 {{ $linkClass }}"
  {{- if $link -}}
    href="{{ $href }}"
    {{ with $external }}target="_blank" rel="noreferrer"{{ end -}}
  {{- end -}}
>
  {{- template "card-inner" (dict
    "image"      $image
    "alt"        $alt
    "width"      $width
    "height"     $height
    "imageStyle" $imageStyle
    "icon"       $icon
    "title"      $title
    "subtitle"   $subtitle
    "tag"        $tag
    "tagColor"   $tagColor
    "tagBorder"  $tagBorder
    "tagIcon"    $tagIcon
  ) -}}
</a>
{{- end -}}
{{- /* Strip trailing newline. */ -}}